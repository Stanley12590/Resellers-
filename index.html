<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reseller Panel - Stany Mines Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&amp;family=Orbitron:wght@400;700;900&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --reseller-bg: #0a0e17;
            --reseller-card: rgba(20, 25, 40, 0.95);
            --reseller-border: rgba(255, 215, 0, 0.3);
            --reseller-primary: #FFD700;
            --reseller-secondary: #00f7ff;
            --reseller-success: #00ff9d;
            --reseller-danger: #ff0055;
            --reseller-text: #ffffff;
            --reseller-muted: #8a9bbd;
            --radius: 12px;
            --font-main: 'Poppins', sans-serif;
            --font-cyber: 'Orbitron', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--reseller-bg);
            color: var(--reseller-text);
            font-family: var(--font-main);
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 215, 0, 0.1), transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(0, 247, 255, 0.1), transparent 40%);
        }

        .reseller-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: var(--reseller-card);
            border-radius: var(--radius);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            border: 2px solid var(--reseller-border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .login-title {
            font-family: var(--font-cyber);
            font-size: 1.8rem;
            text-align: center;
            margin-bottom: 30px;
            color: var(--reseller-primary);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--reseller-border);
            border-radius: 8px;
            color: var(--reseller-text);
            font-family: var(--font-main);
            font-size: 1rem;
        }

        /* Dashboard */
        .reseller-header {
            background: var(--reseller-card);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid var(--reseller-border);
            text-align: center;
        }

        .reseller-title {
            font-family: var(--font-cyber);
            font-size: 1.8rem;
            color: var(--reseller-primary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .reseller-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .info-item {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid var(--reseller-border);
        }

        .info-label {
            color: var(--reseller-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .info-value {
            font-family: var(--font-cyber);
            font-size: 1.2rem;
            color: var(--reseller-primary);
            font-weight: 700;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--reseller-card);
            border-radius: var(--radius);
            padding: 20px;
            border: 2px solid var(--reseller-border);
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--reseller-primary);
        }

        .card-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--reseller-primary);
        }

        .card-value {
            font-family: var(--font-cyber);
            font-size: 1.8rem;
            color: var(--reseller-primary);
            font-weight: 700;
            margin: 10px 0;
        }

        .card-label {
            color: var(--reseller-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Control Panel */
        .control-panel {
            background: var(--reseller-card);
            border-radius: var(--radius);
            padding: 25px;
            border: 2px solid var(--reseller-border);
            margin-bottom: 30px;
        }

        .panel-title {
            font-family: var(--font-cyber);
            color: var(--reseller-primary);
            font-size: 1.1rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--reseller-border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--reseller-text);
            font-weight: 500;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--reseller-border);
            border-radius: 8px;
            color: var(--reseller-text);
            font-family: var(--font-main);
            font-size: 1rem;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Buttons */
        .reseller-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-family: var(--font-cyber);
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .reseller-btn-primary {
            background: linear-gradient(135deg, var(--reseller-primary), #FFA500);
            color: #000;
        }

        .reseller-btn-secondary {
            background: linear-gradient(135deg, var(--reseller-secondary), #0066ff);
            color: #000;
        }

        .reseller-btn-success {
            background: linear-gradient(135deg, var(--reseller-success), #00a86b);
            color: #000;
        }

        .reseller-btn-danger {
            background: linear-gradient(135deg, var(--reseller-danger), #ff0066);
            color: #000;
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        /* Codes Display */
        .codes-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .code-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--reseller-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-value {
            font-family: var(--font-cyber);
            color: var(--reseller-primary);
            letter-spacing: 1px;
        }

        .code-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-used {
            background: rgba(255, 0, 85, 0.2);
            color: var(--reseller-danger);
            border: 1px solid var(--reseller-danger);
        }

        .status-available {
            background: rgba(0, 255, 157, 0.2);
            color: var(--reseller-success);
            border: 1px solid var(--reseller-success);
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 14, 23, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .loading-overlay.active {
            display: flex;
        }

        .reseller-loader {
            width: 50px;
            height: 50px;
            border: 4px solid transparent;
            border-top-color: var(--reseller-primary);
            border-bottom-color: var(--reseller-secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: var(--radius);
            font-family: var(--font-cyber);
            font-weight: 700;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s;
            z-index: 1001;
            min-width: 300px;
            max-width: 400px;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: var(--reseller-success);
            color: #000;
            border: 2px solid var(--reseller-success);
        }

        .notification.error {
            background: var(--reseller-danger);
            color: #000;
            border: 2px solid var(--reseller-danger);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .reseller-container {
                padding: 10px;
            }
            
            .reseller-info {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .reseller-info {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .login-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="reseller-loader"></div>
        <div class="loading-text" id="loadingText">LOADING...</div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Login Page -->
    <div class="login-container" id="loginPage">
        <div class="login-card">
            <h1 class="login-title">
                <i class="fas fa-user-tie"></i> RESELLER LOGIN
            </h1>
            
            <div id="loginForm">
                <input type="text" class="login-input" id="resellerId" 
                       placeholder="Reseller ID">
                
                <input type="password" class="login-input" id="resellerPassword" 
                       placeholder="Password">
                
                <button class="reseller-btn reseller-btn-primary btn-block" onclick="resellerLogin()">
                    <i class="fas fa-sign-in-alt"></i> LOGIN
                </button>
                
                <div style="text-align: center; margin-top: 20px; color: var(--reseller-muted); font-size: 0.8rem;">
                    <p>Contact admin to get reseller account</p>
                    <p>© 2024 Stany Mines Pro</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="reseller-container" id="dashboard" style="display: none;">
        <!-- Header -->
        <div class="reseller-header">
            <h1 class="reseller-title">
                <i class="fas fa-user-tie"></i> RESELLER PANEL
            </h1>
            <div style="color: var(--reseller-secondary); font-family: var(--font-cyber); font-size: 0.9rem;">
                Welcome, <span id="resellerName">Reseller</span>
            </div>
            
            <div class="reseller-info">
                <div class="info-item">
                    <div class="info-label">Your ID</div>
                    <div class="info-value" id="displayId">RES-XXXX</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Status</div>
                    <div class="info-value" style="color: var(--reseller-success);">Active</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Join Date</div>
                    <div class="info-value" id="joinDate">2024-01-01</div>
                </div>
                <div class="info-item">
                    <button class="reseller-btn reseller-btn-danger" onclick="resellerLogout()">
                        <i class="fas fa-sign-out-alt"></i> LOGOUT
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="card-icon">
                    <i class="fas fa-key"></i>
                </div>
                <div class="card-value" id="totalCodes">0</div>
                <div class="card-label">TOTAL CODES</div>
            </div>

            <div class="stat-card">
                <div class="card-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="card-value" id="usedCodes">0</div>
                <div class="card-label">USED CODES</div>
            </div>

            <div class="stat-card">
                <div class="card-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="card-value" id="totalEarnings">0 TZS</div>
                <div class="card-label">TOTAL EARNINGS</div>
            </div>

            <div class="stat-card">
                <div class="card-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="card-value" id="conversionRate">0%</div>
                <div class="card-label">CONVERSION RATE</div>
            </div>
        </div>

        <!-- Generate Codes -->
        <div class="control-panel">
            <h2 class="panel-title">
                <i class="fas fa-bolt"></i> GENERATE CODES
            </h2>
            
            <div class="form-group">
                <label class="form-label">Number of Codes to Generate</label>
                <input type="number" class="form-input" id="codeCount" value="10" min="1" max="100">
            </div>
            
            <div class="form-group">
                <label class="form-label">Duration (Days)</label>
                <select class="form-select" id="codeDuration">
                    <option value="7">7 Days</option>
                    <option value="30" selected>30 Days</option>
                    <option value="90">90 Days</option>
                    <option value="365">365 Days</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Your Price per Code (TZS)</label>
                <input type="number" class="form-input" id="codePrice" value="10000" min="1000">
            </div>
            
            <button class="reseller-btn reseller-btn-primary btn-block" onclick="generateCodes()">
                <i class="fas fa-magic"></i> GENERATE CODES
            </button>
            
            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">Generated Codes (Copy and Sell)</label>
                <textarea class="form-textarea" id="generatedCodes" readonly></textarea>
            </div>
            
            <button class="reseller-btn reseller-btn-secondary btn-block" onclick="copyAllCodes()">
                <i class="fas fa-copy"></i> COPY ALL CODES
            </button>
        </div>

        <!-- My Codes -->
        <div class="control-panel">
            <h2 class="panel-title">
                <i class="fas fa-list"></i> MY CODES
            </h2>
            
            <div style="margin-bottom: 20px;">
                <select class="form-select" id="codesFilter" onchange="filterCodes()">
                    <option value="all">All Codes</option>
                    <option value="available">Available</option>
                    <option value="used">Used</option>
                </select>
            </div>
            
            <div class="codes-list" id="codesList">
                Loading your codes...
            </div>
        </div>

        <!-- Instructions -->
        <div class="control-panel">
            <h2 class="panel-title">
                <i class="fas fa-graduation-cap"></i> HOW TO SELL
            </h2>
            
            <div style="color: var(--reseller-muted); line-height: 1.6;">
                <p><strong>Step-by-Step Guide:</strong></p>
                <ol style="margin-left: 20px; margin-bottom: 15px;">
                    <li>Generate codes using the form above</li>
                    <li>Set your selling price (recommended: 10,000 TZS per code)</li>
                    <li>Share codes with your customers</li>
                    <li>Customers enter codes in the app to activate premium</li>
                    <li>Track which codes are used in "My Codes" section</li>
                </ol>
                
                <p><strong>Tips:</strong></p>
                <ul style="margin-left: 20px; margin-bottom: 15px;">
                    <li>Offer discounts for bulk purchases</li>
                    <li>Provide good customer support</li>
                    <li>Keep track of expiration dates</li>
                    <li>Renew codes for loyal customers</li>
                </ul>
                
                <p><strong>Support:</strong> Contact admin for any issues.</p>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDtWAjmGIWVr3QGESAClBzRkQ5AZr5Zeys",
            authDomain: "stanybots.firebaseapp.com",
            projectId: "stanybots",
            storageBucket: "stanybots.firebasestorage.app",
            messagingSenderId: "381983533939",
            appId: "1:381983533939:web:201157399592c6389df306",
            measurementId: "G-W3C0C280BY"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ==================== UTILITY FUNCTIONS ====================
        function showLoading(show, text = 'LOADING...') {
            const loading = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = text;
            loading.classList.toggle('active', show);
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // ==================== AUTHENTICATION ====================
        async function resellerLogin() {
            const id = document.getElementById('resellerId').value.trim().toUpperCase();
            const password = document.getElementById('resellerPassword').value.trim();
            
            if (!id || !password) {
                showNotification('Enter reseller ID and password', 'error');
                return;
            }
            
            showLoading(true, 'Logging in...');
            
            try {
                // Check if reseller exists
                const snapshot = await database.ref('resellers/' + id).once('value');
                
                if (!snapshot.exists()) {
                    showNotification('Reseller not found', 'error');
                    showLoading(false);
                    return;
                }
                
                const reseller = snapshot.val();
                
                // Check password (in production, use hashing)
                if (reseller.password !== password) {
                    showNotification('Invalid password', 'error');
                    showLoading(false);
                    return;
                }
                
                // Check if reseller is active
                if (reseller.status === 'disabled') {
                    showNotification('Reseller account disabled', 'error');
                    showLoading(false);
                    return;
                }
                
                // Login successful
                localStorage.setItem('resellerId', id);
                localStorage.setItem('resellerData', JSON.stringify(reseller));
                
                showNotification('Login successful!', 'success');
                
                // Load dashboard
                setTimeout(() => {
                    showLoading(false);
                    loadDashboard(id, reseller);
                }, 1000);
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Login error', 'error');
                showLoading(false);
            }
        }

        function resellerLogout() {
            localStorage.removeItem('resellerId');
            localStorage.removeItem('resellerData');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            showNotification('Logged out', 'success');
        }

        // ==================== DASHBOARD FUNCTIONS ====================
        async function loadDashboard(resellerId, resellerData) {
            showLoading(true, 'Loading dashboard...');
            
            try {
                // Update reseller info
                document.getElementById('resellerName').textContent = resellerData.name || 'Reseller';
                document.getElementById('displayId').textContent = resellerId;
                document.getElementById('joinDate').textContent = resellerData.joinDate ? 
                    new Date(resellerData.joinDate).toLocaleDateString() : 'N/A';
                
                // Load stats
                await loadResellerStats(resellerId);
                
                // Load codes
                await loadResellerCodes(resellerId);
                
                // Show dashboard
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
            } catch (error) {
                console.error('Dashboard error:', error);
                showNotification('Error loading dashboard', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadResellerStats(resellerId) {
            try {
                // Load reseller's codes
                const snapshot = await database.ref('resellerCodes/' + resellerId).once('value');
                
                let totalCodes = 0;
                let usedCodes = 0;
                let totalEarnings = 0;
                
                if (snapshot.exists()) {
                    snapshot.forEach(codeSnap => {
                        const code = codeSnap.val();
                        totalCodes++;
                        
                        if (code.used) {
                            usedCodes++;
                            totalEarnings += code.price || 0;
                        }
                    });
                }
                
                // Update UI
                document.getElementById('totalCodes').textContent = totalCodes;
                document.getElementById('usedCodes').textContent = usedCodes;
                document.getElementById('totalEarnings').textContent = formatCurrency(totalEarnings);
                
                const conversionRate = totalCodes > 0 ? Math.round((usedCodes / totalCodes) * 100) : 0;
                document.getElementById('conversionRate').textContent = `${conversionRate}%`;
                
                // Update reseller stats in database
                await database.ref('resellers/' + resellerId).update({
                    totalCodes: totalCodes,
                    usedCodes: usedCodes,
                    totalEarnings: totalEarnings,
                    lastActive: Date.now()
                });
                
            } catch (error) {
                console.error('Stats error:', error);
            }
        }

        async function loadResellerCodes(resellerId) {
            try {
                const snapshot = await database.ref('resellerCodes/' + resellerId).once('value');
                const filter = document.getElementById('codesFilter').value;
                let html = '';
                
                if (!snapshot.exists()) {
                    document.getElementById('codesList').innerHTML = 'No codes generated yet';
                    return;
                }
                
                snapshot.forEach(codeSnap => {
                    const code = codeSnap.val();
                    
                    // Apply filter
                    if (filter === 'available' && code.used) return;
                    if (filter === 'used' && !code.used) return;
                    
                    const status = code.used ? 'Used' : 'Available';
                    const statusClass = code.used ? 'status-used' : 'status-available';
                    const price = code.price ? formatCurrency(code.price) : 'N/A';
                    
                    html += `
                        <div class="code-item">
                            <div>
                                <div class="code-value">${codeSnap.key}</div>
                                <div style="font-size: 0.8rem; color: var(--reseller-muted); margin-top: 5px;">
                                    Expires: ${code.expiresAt ? new Date(code.expiresAt).toLocaleDateString() : 'N/A'} • Price: ${price}
                                </div>
                            </div>
                            <span class="code-status ${statusClass}">${status}</span>
                        </div>
                    `;
                });
                
                document.getElementById('codesList').innerHTML = html || 'No codes match the filter';
                
            } catch (error) {
                console.error('Codes error:', error);
                document.getElementById('codesList').innerHTML = 'Error loading codes';
            }
        }

        function filterCodes() {
            const resellerId = localStorage.getItem('resellerId');
            if (resellerId) {
                loadResellerCodes(resellerId);
            }
        }

        // ==================== CODE GENERATION ====================
        async function generateCodes() {
            const resellerId = localStorage.getItem('resellerId');
            const resellerData = JSON.parse(localStorage.getItem('resellerData') || '{}');
            
            if (!resellerId) {
                showNotification('Please login first', 'error');
                return;
            }
            
            const count = parseInt(document.getElementById('codeCount').value);
            const duration = parseInt(document.getElementById('codeDuration').value);
            const price = parseInt(document.getElementById('codePrice').value);
            
            if (!count || count < 1 || count > 100) {
                showNotification('Enter valid number (1-100)', 'error');
                return;
            }
            
            if (!duration || duration < 1) {
                showNotification('Enter valid duration', 'error');
                return;
            }
            
            if (!price || price < 1000) {
                showNotification('Minimum price is 1,000 TZS', 'error');
                return;
            }
            
            showLoading(true, 'Generating codes...');
            
            try {
                // Check reseller's batch limit
                const batchSnapshot = await database.ref('resellerBatches/' + resellerId).once('value');
                let batchData = batchSnapshot.exists() ? batchSnapshot.val() : null;
                
                if (batchData && batchData.remaining && batchData.remaining < count) {
                    showNotification(`Only ${batchData.remaining} codes remaining in your batch`, 'error');
                    showLoading(false);
                    return;
                }
                
                let codes = '';
                
                for (let i = 0; i < count; i++) {
                    const code = 'RES-' + 
                               Math.random().toString(36).substr(2, 4).toUpperCase() + '-' +
                               Math.random().toString(36).substr(2, 4).toUpperCase();
                    
                    const codeData = {
                        code: code,
                        created: Date.now(),
                        duration: duration,
                        expiresAt: Date.now() + (duration * 24 * 60 * 60 * 1000),
                        price: price,
                        used: false,
                        resellerId: resellerId,
                        resellerName: resellerData.name || 'Unknown',
                        type: 'reseller'
                    };
                    
                    // Save to reseller's codes
                    await database.ref('resellerCodes/' + resellerId + '/' + code).set(codeData);
                    
                    // Save to premium codes (for validation)
                    await database.ref('premiumCodes/' + code).set(codeData);
                    
                    codes += code + '\n';
                }
                
                // Update batch usage
                if (batchData) {
                    await database.ref('resellerBatches/' + resellerId).update({
                        used: (batchData.used || 0) + count,
                        remaining: Math.max(0, (batchData.limit || 0) - ((batchData.used || 0) + count))
                    });
                }
                
                document.getElementById('generatedCodes').value = codes;
                showNotification(`${count} codes generated!`, 'success');
                
                // Refresh stats and codes list
                await loadResellerStats(resellerId);
                await loadResellerCodes(resellerId);
                
            } catch (error) {
                console.error('Generate error:', error);
                showNotification('Error generating codes', 'error');
            } finally {
                showLoading(false);
            }
        }

        function copyAllCodes() {
            const textarea = document.getElementById('generatedCodes');
            
            if (!textarea.value.trim()) {
                showNotification('No codes to copy', 'error');
                return;
            }
            
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showNotification('All codes copied to clipboard!', 'success');
            } catch (error) {
                console.error('Copy error:', error);
                showNotification('Failed to copy', 'error');
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-TZ', {
                style: 'currency',
                currency: 'TZS',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // ==================== INITIALIZATION ====================
        function initializeReseller() {
            // Check if already logged in
            const savedId = localStorage.getItem('resellerId');
            const savedData = localStorage.getItem('resellerData');
            
            if (savedId && savedData) {
                try {
                    const resellerData = JSON.parse(savedData);
                    loadDashboard(savedId, resellerData);
                } catch (error) {
                    localStorage.removeItem('resellerId');
                    localStorage.removeItem('resellerData');
                }
            }
        }

        window.addEventListener('DOMContentLoaded', initializeReseller);
    </script>
</body>
</html>
